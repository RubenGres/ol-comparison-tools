/**
* Author: Thomas Tilak
* github: https://github.com/thhomas/ol-comparison-tools
* licence: MIT
*/

ol.control.ComparisonTools=function(e){e||(e={});let t=this;this.controls_=[],this.clonedMap_,this.clonedLayer_,this.rightLayer_,this.leftLayer_,this.useCloneLayer_=!1,this.layerGroup_,this.vSwipeControl_,this.hSwipeControl_,ol.control.Bar.call(this,{group:!0,toggleOne:!0,className:e.className,controls:this.controls_});let o=e.controlNames||["hSlider","vSlider","scope","clipLayer","doubleMap"];e.rightLayer&&(this.rightLayer_=e.rightLayer),e.leftLayer&&(this.leftLayer_=e.leftLayer),e.layerGroup&&(this.layerGroup_=e.layerGroup),this.useCloneLayer_=!0===e.useCloneLayer&&e.useCloneLayer;for(let e=0;e<o.length;e++){let r=o[e];if("vSlider"===r){let e=new ol.control.Toggle({html:'<i class="fa fa-arrows-v"></i>',className:"vertical-button",title:"Comparaison verticale",active:!1});e.set("name",r+"Toggle"),e.on("change:active",function(e){t.onVerticalControlChange_(e,t)}),this.addControl(e)}else if("hSlider"===r){let e=new ol.control.Toggle({html:'<i class="fa fa-arrows-h"></i>',className:"horizontal-button",title:"Comparaison horizontale",active:!1});e.set("name",r+"Toggle"),e.on("change:active",function(e){t.onHorizontalControlChange_(e,t)}),this.addControl(e)}else if("scope"===r){let e=new ol.control.Toggle({html:'<i class="fa fa-circle-o"></i>',className:"scope-button",name:"scope",title:"Loupe",active:!1});e.set("name",r+"Toggle"),e.on("change:active",function(e){t.onScopeControlChange_(e,t)}),this.addControl(e)}else if("clipLayer"===r){let e=new ol.control.Toggle({html:'<i class="fa fa-eye"></i>',className:"clipLayer-button",title:"Masquer",active:!1});e.set("name",r+"Toggle"),e.on("change:active",function(e){t.onClipLayerControlChange_(e,t)}),this.addControl(e)}else if("doubleMap"===r){let e=new ol.control.Toggle({html:'<i class="fa fa-pause"></i>',className:"doubleMap-button",name:"doubleMap",title:"Double affichage",active:!1});e.set("name",r+"Toggle"),e.on("change:active",function(e){t.onDoubleMapControlChange_(e,t)}),this.addControl(e)}}},ol.inherits(ol.control.ComparisonTools,ol.control.Bar),ol.control.ComparisonTools.prototype.setMap=function(e){if(ol.control.Bar.prototype.setMap.call(this,e),this.layerGroup_||(this.layerGroup_=this.getMap().getLayerGroup()),this.getControl("doubleMapToggle")){let t=e.getViewport().parentElement,o=t.id;if(void 0===o)throw new EvalError("ol.Map div must have an id.");let r=document.createElement("div");r.id=o+"-cloned",r.hidden=!0,t.parentElement.appendChild(r),e.clonedMap_=new ol.Map({target:r,view:e.getView(),controls:[new ol.control.Zoom({zoomInTipLabel:"Zoom avant",zoomOutTipLabel:"Zoom arri√®re"}),new ol.control.Rotate,new ol.control.Attribution]}),e.addInteraction(new ol.interaction.Synchronize({maps:[e.clonedMap_]})),e.clonedMap_.addInteraction(new ol.interaction.Synchronize({maps:[e]}))}},ol.control.ComparisonTools.prototype.getControl=function(e){for(let t=0;t<this.getControls().length;t++)if(this.getControls()[t].get("name")===e)return this.getControls()[t]},ol.control.ComparisonTools.prototype.onVerticalControlChange_=function(e){e.active?(this.vSwipeControl_=new ol.control.Swipe({layers:this.getLeftLayer(),rightLayers:this.getRightLayer(),orientation:"vertical"}),this.vSwipeControl_.set("name","vSlider"),this.getMap().addControl(this.vSwipeControl_)):this.vSwipeControl_&&(this.getMap().removeControl(this.vSwipeControl_),this.vSwipeControl_=void 0)},ol.control.ComparisonTools.prototype.onHorizontalControlChange_=function(e){e.active?(this.hSwipeControl_=new ol.control.Swipe({layers:this.getLeftLayer(),rightLayers:this.getRightLayer(),orientation:"horizontal"}),this.hSwipeControl_.set("name","hSlider"),this.getMap().addControl(this.hSwipeControl_)):this.hSwipeControl_&&(this.getMap().removeControl(this.hSwipeControl_),this.hSwipeControl_=void 0)},ol.control.ComparisonTools.prototype.onScopeControlChange_=function(e){let t=this.getControl("scopeToggle");e.active?(t.setInteraction(new ol.interaction.Clip({radius:200})),this.getMap().addInteraction(t.getInteraction()),t.getInteraction().addLayer(this.getRightLayer())):t.getInteraction()&&(t.getInteraction().removeLayer(this.getRightLayer()),this.getMap().removeInteraction(t.getInteraction()),t.setInteraction())},ol.control.ComparisonTools.prototype.onClipLayerControlChange_=function(e){let t=this.getControl("clipLayerToggle");e.active?(this.getRightLayer().setVisible(!1),t.element.getElementsByClassName("fa")[0].className="fa fa-eye-slash"):(this.useCloneLayer_?"doubleMap"!==this.getDisplayMode()&&this.getRightLayer().setVisible(!0):this.getRightLayer().setVisible(!0),t.element.getElementsByClassName("fa")[0].className="fa fa-eye")},ol.control.ComparisonTools.prototype.onDoubleMapControlChange_=function(e){let t=this.getMap().getViewport().parentElement,o=this.getMap().clonedMap_.getViewport().parentElement;e.active?(o.style.float="left",o.style.width="50%",t.style.width="50%",t.style.float="left",o.style.display="block",o.style.height=t.clientHeight+"px",this.useCloneLayer_?(this.clonedLayer_=new ol.layer.Tile(this.getRightLayer().getProperties()),this.clonedLayer_.setVisible(!0),this.getRightLayer().setVisible(!1),this.getRightLayer().on("change",this.updateClonedLayer_,this),this.getClonedMap().addLayer(this.clonedLayer_)):(this.getRightLayer().setVisible(!0),this.layerGroup_.getLayers().remove(this.getRightLayer()),this.getClonedMap().addLayer(this.getRightLayer())),this.getMap().updateSize(),this.getClonedMap().updateSize()):(o.style.display="none",o.style.width="100%",t.style.width="100%",this.useCloneLayer_?(this.getClonedMap().removeLayer(this.clonedLayer_),"clipLayer"!==this.getDisplayMode()&&this.getRightLayer().setVisible(!0),this.getRightLayer().un("change",this.updateClonedLayer_,this)):("clipLayer"!==this.getDisplayMode()&&this.getRightLayer().setVisible(!0),this.getClonedMap().removeLayer(this.getRightLayer()),this.layerGroup_.getLayers().push(this.getRightLayer()))),this.getMap().updateSize()},ol.control.ComparisonTools.prototype.setDisplayMode=function(e){if(!this.getMap())throw new EvalError("control must be added to map before setting displayMode.");"vSlider"===e?this.getControl("vSliderToggle").setActive(!0):"hSlider"===e?this.getControl("hSliderToggle").setActive(!0):"scope"===e?this.getControl("scopeToggle").setActive(!0):"clipLayer"===e?this.getControl("clipLayerToggle").setActive(!0):"doubleMap"===e&&this.getControl("doubleMapToggle").setActive(!0)},ol.control.ComparisonTools.prototype.getDisplayMode=function(){for(let e=0;e<this.getControls().length;e++)if(this.getControls()[e].getActive())return this.getControls()[e].get("name").substring(0,this.getControls()[e].get("name").length-6);return"normal"},ol.control.ComparisonTools.prototype.setRightLayer=function(e){if(!this.getMap())throw new EvalError("control must be added to map before setting rightLayer.");if("vSlider"===this.getDisplayMode()){let t;this.getMap().getControls().forEach(function(e){"vSlider"===e.get("name")&&(t=e)}),t.removeLayer(this.getRightLayer()),t.addLayer(e,!0)}else if("hSlider"===this.getDisplayMode()){let t;this.getMap().getControls().forEach(function(e){"hSlider"===e.get("name")&&(t=e)}),t.removeLayer(this.getRightLayer()),t.addLayer(e,!0)}else if("clipLayer"===this.getDisplayMode())e.setVisible(this.getRightLayer().getVisible());else if("scope"===this.getDisplayMode()){let t=this.getControl("scopeToggle").getInteraction();t.removeLayer(this.getRightLayer()),t.addLayer(e)}else"doubleMap"===this.getDisplayMode()&&(this.useCloneLayer_?(this.clonedLayer_.setProperties(e.getProperties()),this.getRightLayer().on("change",this.updateClonedLayer_,this),this.getRightLayer().setVisible(!1)):(this.getRightLayer().setVisible(!0),this.layerGroup_.getLayers().remove(e),this.getClonedMap().getLayers().forEach(function(t,o){t===this.getRightLayer()&&this.getClonedMap().getLayers().setAt(o,e)},this)));this.rightLayer_=e},ol.control.ComparisonTools.prototype.updateClonedLayer_=function(){this.clonedLayer_.setProperties(this.getRightLayer().getProperties()),this.clonedLayer_.setVisible(!0)},ol.control.ComparisonTools.prototype.setLeftLayer=function(e){if(!this.getMap())throw new EvalError("control must be added to map before setting leftLayer.");let t,o;this.leftLayer_=e,this.getMap().getControls().forEach(function(e){"vSlider"===e.get("name")&&(t=e)}),t&&t.addLayer(this.getLeftLayer()),this.getMap().getControls().forEach(function(e){"hSlider"===e.get("name")&&(o=e)}),o&&o.addLayer(this.getLeftLayer())},ol.control.ComparisonTools.prototype.getRightLayer=function(){return this.rightLayer_},ol.control.ComparisonTools.prototype.getLeftLayer=function(){return this.leftLayer_},ol.control.ComparisonTools.prototype.getClonedMap=function(){return this.getMap().clonedMap_},ol.control.ComparisonTools.prototype.setLayerGroup=function(e){this.layerGroup_=e},ol.control.ComparisonTools.prototype.getLayerGroup=function(){return this.layerGroup_},ol.control.ComparisonTools.prototype.getVSwipeControl=function(){return this.vSwipeControl_},ol.control.ComparisonTools.prototype.getHSwipeControl=function(){return this.hSwipeControl_},ol.Map.prototype.getClonedMap=function(){return this.clonedMap_},ol.control.HistogramMatching=function(e){e||(e={}),this.layer1_=e.layer1,this.layer2_=e.layer2,this.classCount_=e.classCount?e.classCount:1e3,this.layerProcessed_={},this.active_=!1,ol.control.Toggle.call(this,{html:'<i class="fa fa-bar-chart"></i>',className:"ol-histogram-matching",title:"Adaptation d'histogramme",active:!1})},ol.inherits(ol.control.HistogramMatching,ol.control.Toggle),ol.control.HistogramMatching.prototype.setMap=function(e){ol.control.Control.prototype.setMap.call(this,e),this.on("change:active",this.onToggle_)},ol.control.HistogramMatching.prototype.onToggle_=function(e){let t=this;if($(t.element).find("button").blur(),!0===t.getActive()){let e=new ol.source.Raster({sources:[t.layer1_.getSource(),t.layer2_.getSource()],operationType:"image",operation:t.rasterOperation_,lib:{computeHistogram:t.computeHistogram_,getInverseClassIndex:t.getInverseClassIndex_,getInverseValue:t.getInverseValue_,classCount:t.classCount_}});t.layerProcessed_=new ol.layer.Image({source:e,name:"processedLayer"}),t.getMap().addLayer(t.layerProcessed_),t.getMap().on("moveend",function(){e.changed()})}else t.getMap().removeLayer(t.layerProcessed_),t.getMap().render()},ol.control.HistogramMatching.prototype.rasterOperation_=function(e,t){let o=e[0],r=e[1],i=computeHistogram(r),l=computeHistogram(o);if(0===l.count||void 0===i||0===i.count)return{data:o.data,width:o.width,height:o.height};let a=o.width,n=o.height,s=o.data,h=new Uint8ClampedArray(s.length);for(let e=0,t=0;e<n;++e){for(let e=0;e<a;++e,t+=4){let e=s[t],o=s[t+1],r=s[t+2],a=(s[t+3],t);h[a]=getInverseValue(l.cumulative_red[Math.round(Math.max(0,Math.min(255,e)))],i.inverse_red),h[a+1]=getInverseValue(l.cumulative_green[Math.round(Math.max(0,Math.min(255,o)))],i.inverse_green),h[a+2]=getInverseValue(l.cumulative_blue[Math.round(Math.max(0,Math.min(255,r)))],i.inverse_blue),h[a+3]=255}}return{data:h,width:a,height:n}},ol.control.HistogramMatching.prototype.setLayer1=function(e){this.layer1_=e},ol.control.HistogramMatching.prototype.setLayer2=function(e){this.layer2_=e},ol.control.HistogramMatching.prototype.getInverseClassIndex_=function(e){let t=Math.floor(e*classCount);return t=Math.max(0,Math.min(t,classCount-1))},ol.control.HistogramMatching.prototype.getInverseValue_=function(e,t){if(null==t)throw"inverse values cannot be undefined";let o=getInverseClassIndex(e);if(null==t[o]){let e=o-1;for(;e>=0&&null==t[e];)e--;e<0&&(e=null);let r=o+1;for(;r<classCount&&null==t[r];)r++;if(r>=classCount&&(r=null),null==e)for(let e=0;e<r;e++)t[e]=t[r];else if(null==r)for(let o=e+1;o<classCount;o++)t[o]=t[e];else for(let o=e+1;o<r;o++){let i=(o-e)/(r-e);t[o]=(1-i)*t[e]+i*t[r]}}return t[o]},ol.control.HistogramMatching.prototype.computeHistogram_=function(e){let t={red:new Array(256),cumulative_red:new Array(256),inverse_red:new Array(classCount),green:new Array(256),cumulative_green:new Array(256),inverse_green:new Array(classCount),blue:new Array(256),cumulative_blue:new Array(256),inverse_blue:new Array(classCount),count:0};for(let e=0;e<256;e++)t.red[e]=t.green[e]=t.blue[e]=0;let o=e.data,r=e.width,i=e.height;for(let e=0,l=0;e<i;++e){for(let e=0;e<r;++e,l+=4)t.red[o[l]]+=1,t.green[o[l+1]]+=1,t.blue[o[l+2]]+=1,t.count++}if(t.count<1e-4)throw"Cannot compute cumulative histogram. Count is quite zero...";t.cumulative_red[0]=t.red[0]/t.count,t.cumulative_green[0]=t.green[0]/t.count,t.cumulative_blue[0]=t.blue[0]/t.count;for(let e=1;e<256;e++)t.cumulative_red[e]=t.cumulative_red[e-1]+t.red[e]/t.count,t.cumulative_green[e]=t.cumulative_green[e-1]+t.green[e]/t.count,t.cumulative_blue[e]=t.cumulative_blue[e-1]+t.blue[e]/t.count;for(let e=0;e<classCount;e++)t.inverse_red[e]=t.inverse_green[e]=t.inverse_blue[e]=null;for(let e=0;e<255;e++)t.inverse_red[getInverseClassIndex(t.cumulative_red[e])]=e,t.inverse_green[getInverseClassIndex(t.cumulative_green[e])]=e,t.inverse_blue[getInverseClassIndex(t.cumulative_blue[e])]=e;return t},ol.control.HistogramMatching.prototype.getLayerProcessed=function(){return this.layerProcessed_};